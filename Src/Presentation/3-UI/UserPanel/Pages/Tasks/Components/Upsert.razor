@using TaskoMask.Application.Share.Dtos.Workspace.Tasks
@inject TaskoMask.Presentation.Framework.Share.Contracts.ITaskClientService TaskClientService
@inject TaskoMask.Presentation.Framework.Share.Contracts.ICardClientService CardClientService

<EditForm Model="TaskModel" OnValidSubmit="HandleUpsert">

    <DataAnnotationsValidator />

    <input type="hidden" @bind="TaskModel.CardId" />


    <div class="form-group">
        <InputText @bind-Value="TaskModel.Title" placeholder="Title" class="form-control"></InputText>
        <ValidationMessage For="()=>TaskModel.Title" class="text-danger"></ValidationMessage>
    </div>

    <div class="form-group">
        <select disabled="@isUpdate" @bind="TaskModel.CardId" class="form-control">
            @foreach (var prop in cardsSelectList)
            {
                <option value="@prop.Value" selected="@(prop.Value==TaskModel.CardId?true:false)">@prop.Text</option>
            }
        </select>
        <ValidationMessage For="()=>TaskModel.CardId" class="text-danger"></ValidationMessage>
    </div>

    <div class="form-group">
        <InputTextArea @bind-Value="TaskModel.Description" placeholder="Title" class="form-control"></InputTextArea>
        <ValidationMessage For="()=>TaskModel.Description" class="text-danger"></ValidationMessage>
    </div>

    <div class="form-group">
        @if (isUpdate)
        {
            <button type="submit" class="btn btn-primary mr-1">Update</button>
            <a @onclick="HandleDelete" class="btn btn-danger text-white mr-1">Delete</a>
        }
        else
        {
            <button type="submit" class="btn btn-primary mr-1">Create</button>
        }
        <a @onclick="@(()=>ModalInstance.CancelAsync())" class="btn btn-warning text-white mr-1">Cancel</a>
    </div>

</EditForm>

@code {

    #region Fields and Parameters


    [Parameter]
    public string TaskId { get; set; }

    [Parameter]
    public string CardId { get; set; }

    /// <summary>
    /// cards list to use in DropDownList
    /// </summary>
    IEnumerable<SelectListItem> cardsSelectList = new List<SelectListItem>();



    TaskUpsertDto TaskModel = new TaskUpsertDto();

    /// <summary>
    /// Access to current modal
    /// </summary>
    [CascadingParameter]
    BlazoredModalInstance ModalInstance { get; set; }


    /// <summary>
    /// To specify form role (create or update)
    /// </summary>
    bool isUpdate = false;

    #endregion Fields and Parameters


    #region Protected Methods


    /// <summary>
    ///
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        //get cards select list for DropDownList
        await GetCards();

        //if Id has value so we need to handle update
        if (!string.IsNullOrEmpty(TaskId))
            await PrepareModelToUpdate();
        else
            TaskModel.CardId = CardId;
    }


    #endregion Protected Methods


    #region private Methods



    /// <summary>
    /// Get model by Id from API
    /// </summary>
    private async Task PrepareModelToUpdate()
    {
        isUpdate = true;

        var taskResult = await TaskClientService.Get(TaskId);

        if (taskResult.IsSuccess)
        {
            TaskModel = new TaskUpsertDto
                {
                    Id = taskResult.Value.Task.Id,
                    Title = taskResult.Value.Task.Title,
                    Description = taskResult.Value.Task.Description,
                    CardId = taskResult.Value.Task.CardId,
                };
        }
        else
        {
            //close the modal window
            ModalInstance.CloseAsync();
            ToastService.ShowError(taskResult.Errors.ParseToFragment(), taskResult.Message);
        }
    }


    
    /// <summary>
    /// get cards select list to use in DropDownList
    /// </summary>
    private async Task GetCards()
    {
        var cardsResult = await CardClientService.GetSelectListItems(CardId);
        if (!cardsResult.IsSuccess)
        {
            //close the modal window
            ModalInstance.CloseAsync();
            ToastService.ShowError(cardsResult.Errors.ParseToFragment(), cardsResult.Message);
        }
        else if (cardsResult.Value.Any())
        {
            cardsSelectList = cardsResult.Value;

            if (string.IsNullOrEmpty(TaskModel.CardId))
                TaskModel.CardId = cardsSelectList.First().Value;
        }

    }



    /// <summary>
    /// Handle form role
    /// </summary>
    private async Task HandleUpsert()
    {
        if (isUpdate)
            await HandleUpdate();
        else
            await HandleCreate();
    }



    /// <summary>
    /// handle create model
    /// </summary>
    private async Task HandleCreate()
    {
        TaskModel.CardId = CardId;
        var result = await TaskClientService.Create(TaskModel);
        DataServiceHandler.Handle(result, ToastService, MessageService, MessageType.Card_Created, ModalInstance);
    }



    /// <summary>
    /// handle update model
    /// </summary>
    private async Task HandleUpdate()
    {
        var result = await TaskClientService.Update(TaskId, TaskModel);
        DataServiceHandler.Handle(result, ToastService, MessageService, MessageType.Project_Updated, ModalInstance);
    }



    /// <summary>
    /// handle delete item
    /// </summary>
    private async Task HandleDelete()
    {
        var confirmationModal = ModalService.Show<Confirmation>("Deletion warning!");
        var confirmationModalResult = await confirmationModal.Result;

        if (confirmationModalResult.Cancelled)
            return;

        var result = await TaskClientService.Delete(TaskId);
        DataServiceHandler.Handle(result, ToastService, MessageService, MessageType.Project_Deleted, ModalInstance);
    }

    #endregion private Methods
}
